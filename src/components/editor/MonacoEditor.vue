<template>
  <pre id="editor" @keydown="resetCodeShortcut"></pre>
</template>

<script>
  import * as monaco from 'monaco-editor';

  export default {
    name: 'monaco-editor',
    mounted() {
      addEventListener('dragover', this.dragOverHandler, false)
      addEventListener('drop', this.dropHandler, false)
      addEventListener('keydown', this.saveHandler, false)

      this.editor = 
        monaco.editor.create(document.getElementById('editor'), {
          value: this.$store.state.code[this.$store.state.language],
          minimap: {
            showSlider: false
          },
          language: this.$store.state.languageMode,
          automaticLayout: true,
          dragAndDrop: true,
          fontFamily: this.$store.state.font,
          fontSize: this.$store.state.fontSize,
          parameterHints: true,
          renderIndentGuides: true,
          lineNumbersMinChars: 3,
          theme: this.$store.state.theme,
          scrollBeyondLastLine: false
        })

      this.editor.onDidChangeModelContent(() => {
        this.$store.commit('updateCode', this.editor.getValue())
      })

      this.$store.dispatch('loadDataFromServer')
      this.$store.subscribe((mutation, state) => {
        switch (mutation.type) {
          case "resetCode":
          case "uploadCode":
          case "setCode":
          case "changeLanguage":
            monaco.editor.setModelLanguage(this.editor.getModel(), this.$store.state.languageMode)
            this.editor.setValue(this.$store.state.code[this.$store.state.language])
            break;
          case "changeTheme":
            monaco.editor.setTheme(this.$store.state.theme)
            break;
          case "changeFont":
            this.editor.updateOptions({
              fontFamily: this.$store.state.font
            })
            break;
          case "changeFontSize":
            this.editor.updateOptions({
              fontSize: this.$store.state.fontSize
            })
            break;
          case "resetEditor":
            monaco.editor.setTheme(this.$store.state.theme);
            this.editor.updateOptions({
              fontFamily: this.$store.state.font,
              fontSize: this.$store.state.fontSize
            })
            break;
        }
      })

      this.$store.subscribe((plugin, state) => {
        switch (plugin.type) {
          case "createPersistedState":
            monaco.editor.setTheme(this.$store.state.theme)
            this.editor.updateOptions({
              fontFamily: this.$store.state.font,
              fontSize: this.$store.state.fontSize
            })
            break;
        }
      })
    },
    destroyed() {
      removeEventListener('dragover', this.dragOverHandler, false)
      removeEventListener('drop', this.dropHandler, false)
      removeEventListener('keydown', this.saveHandler, false)
    },
    methods: {
      resetCodeShortcut(e) {
        if(e.ctrlKey&&e.keyCode==77) {
          e.preventDefault()
          this.$store.commit('resetCode', this.$store.state.language)
        }
      },
      dragOverHandler(e) {
        e.preventDefault()
        e.stopPropagation()
      },
      saveHandler(e)  {
        if ((window.navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)  && e.keyCode == 83) {
          e.preventDefault();
          this.$store.dispatch('saveDataToServer')
          .then(({data}) => {
            this.$router.push({name: 'saved', params: {id: data.id}})
            const code = this.$store.state.code[this.$store.state.language]
            const el = document.createElement('a')
            el.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(code))
            el.setAttribute('download', data.id + '.' + this.$store.state.languageMode)
            el.style.display = 'none'
            document.body.appendChild(el)
            document.body.removeChild(el)
            el.click()
          })
        }
      },
      dropHandler(e) {
         e.preventDefault()
         e.stopPropagation()
         const dt = e.dataTransfer
         if (dt && dt.types && (dt.types.indexOf ?
             dt.types.indexOf('Files') !== -1 : dt.types.contains('Files'))) {
           if (File && FileReader) {
             const reader = new FileReader()
             const file = dt.files[0]
             reader.readAsText(file, 'UTF-8')
             reader.onload = (e) => {
               console.log('Uploaded File: ' + file.name)
               this.$notify({
                text: 'Code Uploaded Successfully',
                type: 'success'
               })
               this.$store.commit('uploadCode', e.target.result)
               this.$store.commit('fileNameChange', file.name)
             };
           }
         }
       }
    }
  }
</script>

<style scoped>
  #editor {
    overflow: hidden;
    position: relative;
    border: none;
    height: calc(100vh - 40px);
    width: 100vw;
    z-index: 10;
    margin: 0;
    border-radius: 0;
  }
  .inputarea {
    opacity: 0;
  }
</style>
